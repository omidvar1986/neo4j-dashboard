{% load static %}

{% if item and item.section %}
<div class="tree-section-item"
     data-id="{{ item.section.id }}"
     data-type="section">

    <div class="tree-item tree-section
        {% if selected_section|default:'' == item.section.id|stringformat:'s' %}active{% endif %}
        {% if item.matches_search %}search-match{% endif %}">

        <div class="tree-item-content"
             onclick="window.location.href='?section={{ item.section.id }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}'">

            <span class="tree-expand-icon"
                  onclick="event.stopPropagation(); toggleTreeItem(
                      'tree-section-{{ item.section.id }}',
                      'tree-icon-section-{{ item.section.id }}'
                  );">

                {% if item.children %}
                    <i class="fas fa-chevron-down tree-chevron"
                       id="tree-icon-section-{{ item.section.id }}"></i>
                {% else %}
                    <i class="fas fa-chevron-right tree-chevron tree-chevron-empty"
                       style="opacity:0.4;"></i>
                {% endif %}
            </span>

            <i class="fas fa-folder tree-folder-icon"></i>

            <span class="tree-item-name">
                {{ item.section.name|default:"(No name)" }}
            </span>

            {% if item.matches_search %}
                <i class="fas fa-search"
                   style="margin-left:0.5rem;color:#ffc107;font-size:0.75rem;"
                   title="Matches search"></i>
            {% endif %}
        </div>
    </div>

    {% if item.children %}
    <div id="tree-section-{{ item.section.id }}" class="tree-children" style="display:block;">
        {% for child in item.children %}

            {% if child.type == 'test_case' and child.data %}
                {% with tc=child.data %}
                <div class="tree-item tree-test-case
                    {% if selected_test_case|default:'' == tc.id|stringformat:'s' %}active{% endif %}
                    {% if search_query %}search-match{% endif %}"
                    data-id="{{ tc.id }}"
                    data-type="test_case">

                    <div class="tree-item-content"
                         onclick="window.location.href='?test_case={{ tc.id }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}'">

                        <span class="tree-spacer"></span>
                        <i class="fas fa-file-alt tree-file-icon"></i>

                        <span class="tree-item-name">
                            C{{ tc.id|stringformat:'s'|slice:":8" }}:
                            {{ tc.title|default:"Untitled"|truncatewords:10 }}
                        </span>

                        {% if search_query %}
                            <i class="fas fa-search"
                               style="margin-left:0.5rem;color:#ffc107;font-size:0.75rem;"
                               title="Matches search"></i>
                        {% endif %}
                    </div>
                </div>
                {% endwith %}

            {% elif child.type == 'section' and child.data %}
                {% include 'testcases/tree_item.html'
                   with item=child.data
                   level=level|add:1
                   search_query=search_query %}
            {% endif %}

        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}
