{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Add Test Run - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    .test-run-form-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 2rem;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
    }
    
    .form-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--card-border);
    }
    
    .form-header h1 {
        font-size: 1.75rem;
        color: var(--text-color);
        margin: 0;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-color);
    }
    
    .form-group label.required::after {
        content: " *";
        color: red;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--card-border);
        border-radius: 6px;
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 1rem;
    }
    
    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .form-hint {
        font-size: 0.875rem;
        color: var(--text-color);
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    .radio-group {
        margin: 1rem 0;
    }
    
    .radio-option {
        margin-bottom: 1rem;
        padding: 1rem;
        border: 1px solid var(--card-border);
        border-radius: 6px;
        background: var(--input-bg);
    }
    
    .radio-option input[type="radio"] {
        width: auto;
        margin-right: 0.5rem;
    }
    
    .radio-option label {
        font-weight: 500;
        cursor: pointer;
    }
    
    .radio-option .description {
        font-size: 0.875rem;
        color: var(--text-color);
        opacity: 0.7;
        margin-top: 0.5rem;
        margin-left: 1.5rem;
    }
    
    .test-case-selection {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 6px;
        display: none;
    }
    
    .test-case-selection.active {
        display: block;
    }
    
    .btn-select-cases {
        background: #007bff;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 0.5rem;
    }
    
    .selected-count {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-color);
    }
    
    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--card-border);
    }
    
    .btn-submit {
        background: #28a745;
        color: white;
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
    }
    
    .btn-cancel {
        background: #dc3545;
        color: white;
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-run-form-container">
    <div class="form-header">
        <h1>Add Test Run</h1>
    </div>
    
    <form method="post" id="testRunForm">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="name" class="required">Name</label>
            <input type="text" id="name" name="name" required 
                   value="Test Run {{ 'now'|date:'n/j/Y' }}"
                   placeholder="Ex: Test Run 2014-08-01, Build 240 or Version 3.0">
        </div>
        
        <div class="form-group">
            <label for="references">References</label>
            <textarea id="references" name="references" 
                      placeholder="Add reference ID's to external tickets here."></textarea>
        </div>
        
        <div class="form-group">
            <label for="milestone">Milestone</label>
            <select id="milestone" name="milestone">
                <option value="">-- Select Milestone --</option>
            </select>
            <div class="form-hint">The milestone this test run belongs to.</div>
        </div>
        
        <div class="form-group">
            <label for="assigned_to">Assign To</label>
            <select id="assigned_to" name="assigned_to">
                <option value="">-- Select User --</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>
            <div class="form-hint">The user to whom the tests of the new test run should initially be assigned. An email is sent to the user if email notifications are enabled.</div>
        </div>
        
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" 
                      placeholder="Use this description to describe the purpose of this test run."></textarea>
            <div class="form-hint">Use this description to describe the purpose of this test run.</div>
        </div>
        
        <div class="form-group">
            <label for="start_date">Start Date</label>
            <input type="date" id="start_date" name="start_date">
            <div class="form-hint">The expected or scheduled start date of this test run.</div>
        </div>
        
        <div class="form-group">
            <label for="end_date">End Date</label>
            <input type="date" id="end_date" name="end_date">
            <div class="form-hint">The expected due or end date of this test run.</div>
        </div>
        
        <div class="form-group">
            <label>Test Case Inclusion</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="inclusion_all" name="inclusion_type" value="all" checked>
                    <label for="inclusion_all">Include all test cases</label>
                    <div class="description">Select this option to include all test cases in this test run. If new test cases are added to the repository, they are also automatically included in this run.</div>
                </div>
                
                <div class="radio-option">
                    <input type="radio" id="inclusion_specific" name="inclusion_type" value="specific">
                    <label for="inclusion_specific">Select specific test cases</label>
                    <div class="description">You can alternatively select the test cases to include in this test run. New test cases are not automatically added to this run in this case.</div>
                    <div class="test-case-selection" id="specificSelection">
                        <button type="button" class="btn-select-cases" onclick="openSelectCasesModal()">
                            Select Test Cases
                        </button>
                        <div class="selected-count" id="selectedCount">0 test cases included (change selection)</div>
                        <input type="hidden" name="test_case_ids[]" id="testCaseIds" value="">
                    </div>
                </div>
                
                <div class="radio-option">
                    <input type="radio" id="inclusion_dynamic" name="inclusion_type" value="dynamic">
                    <label for="inclusion_dynamic">Dynamic Filtering</label>
                    <div class="description">Automatically add test cases based on filter selection. New test cases are automatically added to the run if they match the filter (unless the run is closed).</div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-submit">
                <i class="fas fa-check"></i> Add Test Run
            </button>
            <a href="{% url 'testcases:test_run_list' project_id=project.id %}" class="btn-cancel">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<!-- Select Cases Modal -->
<div id="selectCasesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
    <div style="max-width: 1200px; margin: 2rem auto; background: var(--card-bg); border-radius: 8px; padding: 2rem;">
        <h2>Select Cases</h2>
        <div id="casesContent" style="margin-top: 1rem;">
            <p>Loading...</p>
        </div>
        <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
            <button onclick="closeSelectCasesModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveSelectedCases()" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">OK</button>
        </div>
    </div>
</div>

<script>
    // Handle inclusion type change
    document.querySelectorAll('input[name="inclusion_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const specificSelection = document.getElementById('specificSelection');
            if (this.value === 'specific') {
                specificSelection.classList.add('active');
            } else {
                specificSelection.classList.remove('active');
            }
        });
    });
    
    let selectedCases = [];
    
    function openSelectCasesModal() {
        document.getElementById('selectCasesModal').style.display = 'block';
        loadTestCases();
    }
    
    function closeSelectCasesModal() {
        document.getElementById('selectCasesModal').style.display = 'none';
    }
    
    function loadTestCases() {
        fetch('{% url "testcases:test_run_select_cases" project_id=project.id %}')
            .then(response => response.json())
            .then(data => {
                let html = '<div style="display: flex; gap: 2rem;"><div style="flex: 1;"><h3>Test Cases</h3>';
                data.sections.forEach(section => {
                    html += `<div style="margin-bottom: 1rem;"><strong>${section.name}</strong>`;
                    section.test_cases.forEach(tc => {
                        const checked = selectedCases.includes(tc.id) ? 'checked' : '';
                        html += `<div style="margin-left: 1rem;"><input type="checkbox" value="${tc.id}" ${checked}> ${tc.title}</div>`;
                    });
                    html += '</div>';
                });
                html += '</div></div>';
                document.getElementById('casesContent').innerHTML = html;
            });
    }
    
    function saveSelectedCases() {
        const checkboxes = document.querySelectorAll('#casesContent input[type="checkbox"]:checked');
        selectedCases = Array.from(checkboxes).map(cb => cb.value);
        document.getElementById('testCaseIds').value = selectedCases.join(',');
        document.getElementById('selectedCount').textContent = `${selectedCases.length} test cases included (change selection)`;
        closeSelectCasesModal();
    }
    
    // Update form submission to ensure test_case_ids are included
    document.getElementById('testRunForm').addEventListener('submit', function(e) {
        const inclusionType = document.querySelector('input[name="inclusion_type"]:checked').value;
        if (inclusionType === 'specific') {
            const testCaseIds = document.getElementById('testCaseIds').value;
            if (!testCaseIds) {
                e.preventDefault();
                alert('Please select at least one test case.');
                return false;
            }
        }
    });
</script>
{% endblock %}

