{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Edit Test Run - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    .test-run-form-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 2rem;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
    }
    .form-header { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--card-border); }
    .form-header h1 { font-size: 1.75rem; margin: 0; color: var(--text-color); }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); }
    .form-group input,.form-group textarea,.form-group select {
        width: 100%; padding: 0.75rem; border: 1px solid var(--card-border); border-radius: 6px;
        background: var(--input-bg); color: var(--text-color); font-size: 1rem;
    }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-hint { font-size: 0.875rem; color: var(--text-color); opacity: 0.7; margin-top: 0.25rem; }
    .radio-option { margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--card-border); border-radius: 6px; background: var(--input-bg); }
    .radio-option input[type="radio"] { width: auto; margin-right: 0.5rem; }
    .radio-option .description { font-size: 0.875rem; color: var(--text-color); opacity: 0.7; margin-top: 0.5rem; margin-left: 1.5rem; }
    .test-case-selection { margin-top: 1rem; padding: 1rem; border: 1px solid var(--card-border); border-radius: 6px; display: none; }
    .test-case-selection.active { display: block; }
    .btn-select-cases { background: #007bff; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    .selected-count { margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-color); }
    .form-actions { display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid var(--card-border); padding-top: 1rem; }
    .btn-submit { background: #28a745; color: white; padding: 0.75rem 2rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500; }
    .btn-cancel { background: #6c757d; color: white; padding: 0.75rem 2rem; border: none; border-radius: 6px; text-decoration: none; display: inline-block; }
</style>
{% endblock %}

{% block content %}
<div class="test-run-form-container">
    <div class="form-header">
        <h1>Edit Test Run</h1>
    </div>

    <form method="post" id="testRunForm">
        {% csrf_token %}

        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" value="{{ test_run.name }}" required>
        </div>

        <div class="form-group">
            <label for="references">References</label>
            <textarea id="references" name="references">{{ test_run.references }}</textarea>
        </div>

        <div class="form-group">
            <label for="assigned_to">Assign To</label>
            <select id="assigned_to" name="assigned_to">
                <option value="">-- Select User --</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if test_run.assigned_to_id == user.id %}selected{% endif %}>{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description">{{ test_run.description }}</textarea>
        </div>

        <div class="form-group">
            <label for="start_date">Start Date</label>
            <input type="date" id="start_date" name="start_date" value="{{ test_run.start_date|date:'Y-m-d' }}">
        </div>

        <div class="form-group">
            <label for="end_date">End Date</label>
            <input type="date" id="end_date" name="end_date" value="{{ test_run.end_date|date:'Y-m-d' }}">
        </div>

        <div class="form-group">
            <label>Test Case Selection</label>
            <div class="test-case-selection active" id="specificSelection">
                <button type="button" class="btn-select-cases" onclick="openSelectCasesModal()">Select Test Cases</button>
                <div class="selected-count" id="selectedCount">{{ test_run.test_case_ids|length }} test case(s) included (change selection)</div>
                <input type="hidden" name="inclusion_type" value="specific">
                <input type="hidden" name="test_case_ids[]" id="testCaseIds" value="{{ selected_case_ids_str }}">
            </div>
            <div class="form-hint">Select the test cases to include in this test run.</div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit"><i class="fas fa-check"></i> Update Test Run</button>
            <a href="{% url 'testcases:test_run_list' project_id=project.id %}" class="btn-cancel">Cancel</a>
        </div>
    </form>
</div>

<!-- Select Cases Modal -->
<div id="selectCasesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
    <div style="max-width: 1400px; margin: 2rem auto; background: var(--card-bg); border-radius: 8px; padding: 0; display: flex; flex-direction: column; height: calc(100vh - 4rem);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--card-border);">
            <h2 style="margin: 0; color: var(--text-color);">Select Cases</h2>
        </div>
        <div style="flex: 1; display: flex; overflow: hidden;">
            <!-- Left Pane: Section Tree -->
            <div style="width: 300px; border-right: 1px solid var(--card-border); overflow: hidden; background: var(--input-bg); display: flex; flex-direction: column;">
                <div style="padding: 1rem; border-bottom: 1px solid var(--card-border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span style="font-weight: 600; color: var(--text-color);">Sections</span>
                        <div>
                            <a href="#" onclick="selectAllSections(); return false;" style="color: var(--btn-primary-bg); text-decoration: none; font-size: 0.875rem; margin-right: 0.5rem;">Select All</a>
                            <span style="color: var(--text-color); opacity: 0.5;">|</span>
                            <a href="#" onclick="selectNoneSections(); return false;" style="color: var(--btn-primary-bg); text-decoration: none; font-size: 0.875rem; margin-left: 0.5rem;">None</a>
                        </div>
                    </div>
                    <input type="text" id="sectionSearch" placeholder="Search sections..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid var(--card-border); border-radius: 4px; background: var(--card-bg); color: var(--text-color); font-size: 0.875rem;"
                           onkeyup="filterSections(this.value)">
                </div>
                <div id="sectionsTree" style="flex: 1; overflow-y: auto; padding: 0.5rem;">
                    <p style="padding: 1rem; color: var(--text-color); opacity: 0.7;">Loading...</p>
                </div>
            </div>
            
            <!-- Middle Pane: Test Cases List -->
            <div style="flex: 1; overflow-y: auto; background: var(--card-bg);">
                <div style="padding: 1rem; border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between; align-items: center;">
                    <span id="currentSectionTitle" style="font-weight: 600; color: var(--text-color);">Select a section</span>
                    <div>
                        <button onclick="toggleColumns()" style="padding: 0.25rem 0.75rem; background: var(--input-bg); border: 1px solid var(--card-border); border-radius: 4px; cursor: pointer; color: var(--text-color); font-size: 0.875rem;">Columns</button>
                        <a href="#" onclick="selectAllCases(); return false;" style="color: var(--btn-primary-bg); text-decoration: none; font-size: 0.875rem; margin-left: 1rem; margin-right: 0.5rem;">Select All</a>
                        <span style="color: var(--text-color); opacity: 0.5;">|</span>
                        <a href="#" onclick="selectNoneCases(); return false;" style="color: var(--btn-primary-bg); text-decoration: none; font-size: 0.875rem; margin-left: 0.5rem;">None</a>
                    </div>
                </div>
                <div id="testCasesList" style="padding: 1rem;">
                    <p style="text-align: center; color: var(--text-color); opacity: 0.7; padding: 2rem;">Select a section to view test cases</p>
                </div>
            </div>
        </div>
        <div style="padding: 1rem; border-top: 1px solid var(--card-border); display: flex; justify-content: flex-end; gap: 1rem; background: var(--input-bg);">
            <button onclick="closeSelectCasesModal()" style="padding: 0.5rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveSelectedCases()" style="padding: 0.5rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">OK</button>
        </div>
    </div>
</div>

<script>
    const selectedCasesInitial = {{ selected_case_ids_json|safe }};
    let selectedCases = Array.isArray(selectedCasesInitial) ? selectedCasesInitial.slice() : [];
    let sectionsData = [];
    let currentSectionId = null;
    
    function openSelectCasesModal() {
        document.getElementById('selectCasesModal').style.display = 'block';
        loadSectionsTree();
    }
    
    function closeSelectCasesModal() {
        document.getElementById('selectCasesModal').style.display = 'none';
    }
    
    function loadSectionsTree() {
        fetch('{% url "testcases:test_run_select_cases" project_id=project.id %}')
            .then(response => response.json())
            .then(data => {
                sectionsData = data.sections;
                buildSectionsTree(data.sections);
            });
    }
    
    function buildSectionsTree(sections) {
        // Add expanded property to all sections recursively
        function addExpandedProperty(sectionList) {
            sectionList.forEach(section => {
                section.expanded = true; // expand by default
                if (section.children && section.children.length > 0) {
                    addExpandedProperty(section.children);
                }
            });
        }
        addExpandedProperty(sections);
        
        // Helper function to check if all children of a section are selected
        function areAllChildrenSelected(section) {
            const allCases = getAllTestCases(section);
            if (allCases.length === 0) return false;
            return allCases.every(tc => selectedCases.includes(tc.id));
        }
        
        // Render tree
        let html = '';
        function renderSection(section, level = 0) {
            const indent = level * 18;
            const hasSubsections = section.children && section.children.length > 0;
            const hasTestCases = section.test_cases && section.test_cases.length > 0;
            const hasChildren = hasSubsections || hasTestCases;
            const expandIcon = hasChildren
                ? (section.expanded ? '<i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>'
                                    : '<i class="fas fa-chevron-right" style="font-size: 0.75rem;"></i>')
                : '<span style="width: 12px; display: inline-block;"></span>';
            const folderIcon = '<i class="fas fa-folder" style="color: #ffa500; margin-right: 0.25rem;"></i>';
            const isSelected = currentSectionId === section.id;
            const bgColor = isSelected ? 'var(--btn-primary-bg)' : 'transparent';
            const textColor = isSelected ? 'white' : 'var(--text-color)';
            const isSectionChecked = areAllChildrenSelected(section);
            
            html += `<div class="section-tree-item" 
                          style="padding: 0 0.5rem; margin: 0; cursor: pointer; border-radius: 2px; color: ${textColor}; background: ${bgColor}; display: flex; align-items: center; transition: all 0.2s; line-height: 1.1; min-height: 22px;" 
                          onmouseover="if (currentSectionId !== '${section.id}') this.style.background='var(--table-hover-bg)'" 
                          onmouseout="if (currentSectionId !== '${section.id}') this.style.background='transparent'"
                          onclick="selectSection('${section.id}')"
                          data-section-id="${section.id}">`;
            html += `<span style="margin-right: 0.5rem; width: 16px; display: inline-flex; align-items: center; justify-content: center; padding-left: ${indent}px;" onclick="event.stopPropagation(); toggleSection('${section.id}')">${expandIcon}</span>`;
            html += `<input type="checkbox" ${isSectionChecked ? 'checked' : ''} onclick="event.stopPropagation(); toggleSectionCheckbox('${section.id}', this.checked)" style="margin-right: 0.5rem; cursor: pointer;">`;
            html += `${folderIcon}`;
            html += `<span style="flex: 1; white-space: normal; font-size: 0.9rem;">${escapeHtml(section.name)}</span>`;
            html += `</div>`;
            
            if (hasChildren && section.expanded) {
                html += `<div id="section-children-${section.id}" style="display: block; margin: 0; padding: 0;">`;
                
                // Render test cases first (directly under section)
                if (hasTestCases) {
                    section.test_cases.forEach(tc => {
                        const tcIndent = (level + 1) * 18;
                        const isChecked = selectedCases.includes(tc.id);
                        html += `<div class="test-case-tree-item" 
                                      style="padding: 0 0.5rem; margin: 0; cursor: pointer; border-radius: 2px; color: var(--text-color); display: flex; align-items: center; line-height: 1.1; min-height: 20px;"
                                      onmouseover="this.style.background='var(--table-hover-bg)'" 
                                      onmouseout="this.style.background='transparent'"
                                      data-test-case-id="${tc.id}">`;
                        html += `<span style="width: 12px; display: inline-block; margin-right: 0.5rem; padding-left: ${tcIndent}px;"></span>`;
                        html += `<input type="checkbox" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation(); toggleTestCaseCheckbox('${tc.id}', this.checked)" style="margin-right: 0.5rem; cursor: pointer;">`;
                        html += `<i class="fas fa-file-alt" style="color: #4a90e2; margin-right: 0.25rem; font-size: 0.8rem;"></i>`;
                        html += `<span style="flex: 1; white-space: normal; font-size: 0.85rem;">${escapeHtml(tc.title)}</span>`;
                        html += `</div>`;
                    });
                }
                
                // Then render subsections
                if (hasSubsections) {
                    section.children.forEach(child => {
                        renderSection(child, level + 1);
                    });
                }
                
                html += `</div>`;
            } else if (hasChildren) {
                html += `<div id="section-children-${section.id}" style="display: none;"></div>`;
            }
        }
        
        sections.forEach(section => {
            renderSection(section);
        });
        
        document.getElementById('sectionsTree').innerHTML = html;
    }
    
    function toggleSection(sectionId) {
        const section = findSectionInTree(sectionsData, sectionId);
        if (!section) return;
        
        section.expanded = !section.expanded;
        const childrenDiv = document.getElementById(`section-children-${sectionId}`);
        if (childrenDiv) {
            childrenDiv.style.display = section.expanded ? 'block' : 'none';
        }
        
        // Update icon
        const sectionDiv = document.querySelector(`[data-section-id="${sectionId}"]`);
        if (sectionDiv) {
            const iconSpan = sectionDiv.querySelector('span:first-child');
            if (iconSpan) {
                iconSpan.innerHTML = section.expanded ? '<i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>' : '<i class="fas fa-chevron-right" style="font-size: 0.75rem;"></i>';
            }
        }
    }
    
    function findSectionInTree(sections, sectionId) {
        for (const section of sections) {
            if (section.id === sectionId) {
                return section;
            }
            if (section.children && section.children.length > 0) {
                const found = findSectionInTree(section.children, sectionId);
                if (found) return found;
            }
        }
        return null;
    }
    
    function selectSection(sectionId) {
        // Remove previous selection highlight
        document.querySelectorAll('.section-tree-item').forEach(item => {
            if (item.dataset.sectionId !== sectionId) {
                item.style.background = 'transparent';
                item.style.color = 'var(--text-color)';
            }
        });
        
        currentSectionId = sectionId;
        const section = findSectionInTree(sectionsData, sectionId);
        
        if (section) {
            // Highlight selected section
            const sectionDiv = document.querySelector(`[data-section-id="${sectionId}"]`);
            if (sectionDiv) {
                sectionDiv.style.background = 'var(--btn-primary-bg)';
                sectionDiv.style.color = 'white';
            }
            
            document.getElementById('currentSectionTitle').textContent = section.name;
            renderTestCases(getAllTestCases(section));
        }
    }
    
    function getAllTestCases(section) {
        let cases = [];
        if (section.test_cases && section.test_cases.length) {
            cases = cases.concat(section.test_cases);
        }
        if (section.children && section.children.length) {
            section.children.forEach(child => {
                cases = cases.concat(getAllTestCases(child));
            });
        }
        return cases;
    }
    
    function toggleSectionCheckbox(sectionId, checked) {
        const section = findSectionInTree(sectionsData, sectionId);
        if (section) {
            // Get all test cases in this section and all subsections
            const allCases = getAllTestCases(section);
            
            if (checked) {
                // Add all test cases to selectedCases
                allCases.forEach(tc => {
                    if (!selectedCases.includes(tc.id)) {
                        selectedCases.push(tc.id);
                    }
                });
            } else {
                // Remove all test cases from selectedCases
                selectedCases = selectedCases.filter(id => !allCases.find(tc => tc.id === id));
            }
            
            // Update visual state of all child checkboxes (sections and test cases)
            updateSectionCheckboxStates(section, checked);
            
            updateSelectedCount();
            if (currentSectionId === sectionId) {
                renderTestCases(getAllTestCases(section));
            }
        }
    }
    
    function updateSectionCheckboxStates(section, checked) {
        // Update this section's checkbox
        const sectionCheckbox = document.querySelector(`[data-section-id="${section.id}"] input[type="checkbox"]`);
        if (sectionCheckbox) {
            sectionCheckbox.checked = checked;
        }
        
        // Update all test cases' checkboxes in this section
        if (section.test_cases) {
            section.test_cases.forEach(tc => {
                const tcCheckbox = document.querySelector(`[data-test-case-id="${tc.id}"] input[type="checkbox"]`);
                if (tcCheckbox) {
                    tcCheckbox.checked = checked;
                }
            });
        }
        
        // Recursively update all child sections
        if (section.children) {
            section.children.forEach(child => {
                updateSectionCheckboxStates(child, checked);
            });
        }
    }
    
    function toggleTestCaseCheckbox(testCaseId, checked) {
        if (checked) {
            if (!selectedCases.includes(testCaseId)) {
                selectedCases.push(testCaseId);
            }
        } else {
            selectedCases = selectedCases.filter(id => id !== testCaseId);
        }
        
        // Update parent section checkboxes to reflect the new state
        updateParentSectionCheckboxes(testCaseId);
        
        updateSelectedCount();
    }
    
    function updateParentSectionCheckboxes(testCaseId) {
        // Update all section checkboxes to reflect current selection state
        function updateAllSectionCheckboxes(sections) {
            sections.forEach(section => {
                const allCases = getAllTestCases(section);
                const allSelected = allCases.length > 0 && allCases.every(tc => selectedCases.includes(tc.id));
                
                const checkbox = document.querySelector(`[data-section-id="${section.id}"] input[type="checkbox"]`);
                if (checkbox) {
                    checkbox.checked = allSelected;
                }
                
                // Recursively update child sections
                if (section.children) {
                    updateAllSectionCheckboxes(section.children);
                }
            });
        }
        
        updateAllSectionCheckboxes(sectionsData);
    }
    
    function renderTestCases(testCases) {
        if (testCases.length === 0) {
            document.getElementById('testCasesList').innerHTML = '<p style="text-align: center; color: var(--text-color); opacity: 0.7; padding: 2rem;">No test cases in this section</p>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead style="background: var(--input-bg); position: sticky; top: 0;">';
        html += '<tr>';
        html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--card-border); width: 30px;"><input type="checkbox" onclick="toggleAllCases(this.checked)"></th>';
        html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--card-border);">Title</th>';
        html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--card-border);">Type</th>';
        html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--card-border);">Priority</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        testCases.forEach(tc => {
            const checked = selectedCases.includes(tc.id) ? 'checked' : '';
            html += `<tr style="border-bottom: 1px solid var(--card-border);">`;
            html += `<td style="padding: 0.75rem;"><input type="checkbox" value="${tc.id}" ${checked} onchange="updateSelectedCases()"></td>`;
            html += `<td style="padding: 0.75rem; color: var(--text-color);">${escapeHtml(tc.title)}</td>`;
            html += `<td style="padding: 0.75rem; color: var(--text-color);">${tc.type || 'Other'}</td>`;
            html += `<td style="padding: 0.75rem; color: var(--text-color);">${tc.priority || 'Medium'}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        document.getElementById('testCasesList').innerHTML = html;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function updateSelectedCases() {
        const checkboxes = document.querySelectorAll('#testCasesList input[type="checkbox"]:checked');
        selectedCases = Array.from(checkboxes).map(cb => cb.value);
        updateSelectedCount();
    }
    
    function toggleAllCases(checked) {
        document.querySelectorAll('#testCasesList tbody input[type="checkbox"]').forEach(cb => {
            cb.checked = checked;
        });
        updateSelectedCases();
    }
    
    function selectAllSections() {
        document.querySelectorAll('#sectionsTree input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
        });
        selectedCases = [];
        sectionsData.forEach(sec => {
            getAllTestCases(sec).forEach(tc => {
                if (!selectedCases.includes(tc.id)) {
                    selectedCases.push(tc.id);
                }
            });
        });
        updateSelectedCount();
    }
    
    function selectNoneSections() {
        document.querySelectorAll('#sectionsTree input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        selectedCases = [];
        updateSelectedCount();
    }
    
    function selectAllCases() {
        toggleAllCases(true);
    }
    
    function selectNoneCases() {
        toggleAllCases(false);
    }
    
    function toggleFilter(filterName) {
        // Placeholder for filter toggle
        console.log('Toggle filter:', filterName);
    }
    
    function applyFilter() {
        // Placeholder for filter application
        console.log('Apply filter');
    }
    
    function toggleColumns() {
        // Placeholder for column toggle
        console.log('Toggle columns');
    }
    
    function filterSections(searchTerm) {
        const term = searchTerm.toLowerCase();
        const allItems = document.querySelectorAll('.section-tree-item');
        
        allItems.forEach(item => {
            const sectionName = item.textContent.toLowerCase();
            const sectionDiv = item.closest('[data-section-id]') || item;
            const sectionId = sectionDiv.dataset.sectionId;
            
            // Check if section or any parent/child matches
            let shouldShow = false;
            if (term === '' || sectionName.includes(term)) {
                shouldShow = true;
            } else {
                // Check children
                const childrenDiv = document.getElementById(`section-children-${sectionId}`);
                if (childrenDiv) {
                    const childItems = childrenDiv.querySelectorAll('.section-tree-item');
                    childItems.forEach(child => {
                        if (child.textContent.toLowerCase().includes(term)) {
                            shouldShow = true;
                        }
                    });
                }
            }
            
            item.style.display = shouldShow ? 'flex' : 'none';
            
            // If a child matches, expand parent
            if (shouldShow && term !== '') {
                let parent = item.parentElement;
                while (parent && parent.id && parent.id.startsWith('section-children-')) {
                    const parentId = parent.id.replace('section-children-', '');
                    const parentSection = findSectionInTree(sectionsData, parentId);
                    if (parentSection) {
                        parentSection.expanded = true;
                        parent.style.display = 'block';
                        // Update parent icon
                        const parentDiv = document.querySelector(`[data-section-id="${parentId}"]`);
                        if (parentDiv) {
                            const iconSpan = parentDiv.querySelector('span:first-child');
                            if (iconSpan) {
                                iconSpan.innerHTML = '<i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>';
                            }
                        }
                    }
                    parent = parent.parentElement;
                }
            }
        });
    }
    
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = `${selectedCases.length} test case${selectedCases.length !== 1 ? 's' : ''} included (change selection)`;
    }
    
    function saveSelectedCases() {
        document.getElementById('testCaseIds').value = selectedCases.join(',');
        updateSelectedCount();
        closeSelectCasesModal();
    }
    
    // Update form submission to ensure test_case_ids are included
    document.getElementById('testRunForm').addEventListener('submit', function(e) {
        const testCaseIds = document.getElementById('testCaseIds').value;
        if (!testCaseIds) {
            e.preventDefault();
            alert('Please select at least one test case.');
            return false;
        }
    });
    
    // Initialize selected count on page load
    updateSelectedCount();
</script>
{% endblock %}

