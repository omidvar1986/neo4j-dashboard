{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Edit Test Run - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    .test-run-form-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 2rem;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
    }
    .form-header { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--card-border); }
    .form-header h1 { font-size: 1.75rem; margin: 0; color: var(--text-color); }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); }
    .form-group input,.form-group textarea,.form-group select {
        width: 100%; padding: 0.75rem; border: 1px solid var(--card-border); border-radius: 6px;
        background: var(--input-bg); color: var(--text-color); font-size: 1rem;
    }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-hint { font-size: 0.875rem; color: var(--text-color); opacity: 0.7; margin-top: 0.25rem; }
    .radio-option { margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--card-border); border-radius: 6px; background: var(--input-bg); }
    .radio-option input[type="radio"] { width: auto; margin-right: 0.5rem; }
    .radio-option .description { font-size: 0.875rem; color: var(--text-color); opacity: 0.7; margin-top: 0.5rem; margin-left: 1.5rem; }
    .test-case-selection { margin-top: 1rem; padding: 1rem; border: 1px solid var(--card-border); border-radius: 6px; display: none; }
    .test-case-selection.active { display: block; }
    .btn-select-cases { background: #007bff; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    .selected-count { margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-color); }
    .form-actions { display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid var(--card-border); padding-top: 1rem; }
    .btn-submit { background: #28a745; color: white; padding: 0.75rem 2rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500; }
    .btn-cancel { background: #6c757d; color: white; padding: 0.75rem 2rem; border: none; border-radius: 6px; text-decoration: none; display: inline-block; }
</style>
{% endblock %}

{% block content %}
<div class="test-run-form-container">
    <div class="form-header">
        <h1>Edit Test Run</h1>
    </div>

    <form method="post" id="testRunForm">
        {% csrf_token %}

        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" value="{{ test_run.name }}" required>
        </div>

        <div class="form-group">
            <label for="references">References</label>
            <textarea id="references" name="references">{{ test_run.references }}</textarea>
        </div>

        <div class="form-group">
            <label for="milestone">Milestone</label>
            <select id="milestone" name="milestone">
                <option value="">-- Select Milestone --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="assigned_to">Assign To</label>
            <select id="assigned_to" name="assigned_to">
                <option value="">-- Select User --</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if test_run.assigned_to_id == user.id %}selected{% endif %}>{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description">{{ test_run.description }}</textarea>
        </div>

        <div class="form-group">
            <label for="start_date">Start Date</label>
            <input type="date" id="start_date" name="start_date" value="{{ test_run.start_date|date:'Y-m-d' }}">
        </div>

        <div class="form-group">
            <label for="end_date">End Date</label>
            <input type="date" id="end_date" name="end_date" value="{{ test_run.end_date|date:'Y-m-d' }}">
        </div>

        <div class="form-group">
            <label>Test Case Inclusion</label>
            <div class="radio-option">
                <input type="radio" id="inclusion_all" name="inclusion_type" value="all" {% if test_run.inclusion_type == 'all' %}checked{% endif %}>
                <label for="inclusion_all">Include all test cases</label>
            </div>
            <div class="radio-option">
                <input type="radio" id="inclusion_specific" name="inclusion_type" value="specific" {% if test_run.inclusion_type == 'specific' %}checked{% endif %}>
                <label for="inclusion_specific">Select specific test cases</label>
                <div class="test-case-selection {% if test_run.inclusion_type == 'specific' %}active{% endif %}" id="specificSelection">
                    <button type="button" class="btn-select-cases" onclick="openSelectCasesModal()">Select Test Cases</button>
                    <div class="selected-count" id="selectedCount">{{ test_run.test_case_ids|length }} test case(s) included</div>
                    <input type="hidden" name="test_case_ids[]" id="testCaseIds" value="{{ selected_case_ids_str }}">
                </div>
            </div>
            <div class="radio-option">
                <input type="radio" id="inclusion_dynamic" name="inclusion_type" value="dynamic" {% if test_run.inclusion_type == 'dynamic' %}checked{% endif %}>
                <label for="inclusion_dynamic">Dynamic filtering</label>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit"><i class="fas fa-check"></i> Update Test Run</button>
            <a href="{% url 'testcases:test_run_list' project_id=project.id %}" class="btn-cancel">Cancel</a>
        </div>
    </form>
</div>

<!-- Select Cases Modal -->
<div id="selectCasesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
    <div style="max-width: 1200px; margin: 2rem auto; background: var(--card-bg); border-radius: 8px; padding: 2rem;">
        <h2>Select Cases</h2>
        <div id="casesContent" style="margin-top: 1rem;">
            <p>Loading...</p>
        </div>
        <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
            <button onclick="closeSelectCasesModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveSelectedCases()" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">OK</button>
        </div>
    </div>
</div>

<script>
    const selectedCasesInitial = {{ selected_case_ids_json|safe }};
    let selectedCases = Array.isArray(selectedCasesInitial) ? selectedCasesInitial.slice() : [];

    document.querySelectorAll('input[name="inclusion_type"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const section = document.getElementById('specificSelection');
            if (this.value === 'specific') {
                section.classList.add('active');
            } else {
                section.classList.remove('active');
            }
        });
    });

    function openSelectCasesModal() {
        document.getElementById('selectCasesModal').style.display = 'block';
        loadTestCases();
    }

    function closeSelectCasesModal() {
        document.getElementById('selectCasesModal').style.display = 'none';
    }

    function loadTestCases() {
        fetch('{% url "testcases:test_run_select_cases" project_id=project.id %}')
            .then(response => response.json())
            .then(data => {
                let html = '<div style="max-height: 70vh; overflow:auto;">';
                data.sections.forEach(section => {
                    html += `<div style="margin-bottom: 1rem;"><strong>${section.name}</strong>`;
                    section.test_cases.forEach(tc => {
                        const checked = selectedCases.includes(tc.id) ? 'checked' : '';
                        html += `<div style="margin-left: 1rem;"><label><input type="checkbox" value="${tc.id}" ${checked}> ${tc.title}</label></div>`;
                    });
                    html += '</div>';
                });
                html += '</div>';
                document.getElementById('casesContent').innerHTML = html;
            });
    }

    function saveSelectedCases() {
        const checkboxes = document.querySelectorAll('#casesContent input[type="checkbox"]:checked');
        selectedCases = Array.from(checkboxes).map(cb => cb.value);
        document.getElementById('testCaseIds').value = selectedCases.join(',');
        document.getElementById('selectedCount').textContent = `${selectedCases.length} test case(s) included`;
        closeSelectCasesModal();
    }

    document.getElementById('testRunForm').addEventListener('submit', function (e) {
        const inclusionType = document.querySelector('input[name="inclusion_type"]:checked').value;
        if (inclusionType === 'specific' && !document.getElementById('testCaseIds').value.trim()) {
            e.preventDefault();
            alert('Please select at least one test case.');
        }
    });

    // ensure initial label matches existing selection
    document.getElementById('selectedCount').textContent = `${selectedCases.length} test case(s) included`;
</script>
{% endblock %}

