{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Test Runs & Results - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    .test-run-page {
        padding: 1rem;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--card-border);
    }
    
    .page-header h1 {
        font-size: 1.75rem;
        color: var(--text-color);
        margin: 0;
    }
    
    .header-actions {
        display: flex;
        gap: 1rem;
    }
    
    .btn-add-run {
        background: #007bff;
        color: white !important;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s;
    }
    
    .btn-add-run:hover {
        background: #0056b3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }
    
    .filter-section {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-section label {
        font-weight: 500;
        color: var(--text-color);
    }
    
    .filter-section select {
        padding: 0.5rem;
        border: 1px solid var(--card-border);
        border-radius: 4px;
        background: var(--input-bg);
        color: var(--text-color);
    }
    
    .test-runs-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .test-run-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 1.5rem;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .test-run-card:hover {
        box-shadow: 0 4px 12px var(--shadow);
        transform: translateY(-2px);
    }
    
    .test-run-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .test-run-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
    }
    
    .test-run-meta {
        font-size: 0.875rem;
        color: var(--text-color);
        opacity: 0.7;
    }
    
    .test-run-stats {
        display: flex;
        gap: 1rem;
        margin: 1rem 0;
        flex-wrap: wrap;
    }
    
    .stat-item {
        font-size: 0.875rem;
    }
    
    .stat-item.passed {
        color: #28a745;
    }
    
    .stat-item.blocked {
        color: #6c757d;
    }
    
    .stat-item.retest {
        color: #ffc107;
    }
    
    .stat-item.failed {
        color: #dc3545;
    }
    
    .progress-bar-container {
        margin: 1rem 0;
    }
    
    .progress-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
    }
    
    .progress-segment {
        height: 100%;
    }
    
    .progress-segment.passed {
        background: #28a745;
    }
    
    .progress-segment.failed {
        background: #dc3545;
    }
    
    .progress-segment.blocked {
        background: #6c757d;
    }
    
    .progress-segment.retest {
        background: #ffc107;
    }
    
    .progress-segment.untested {
        background: #e9ecef;
    }
    
    .progress-percent {
        font-size: 0.875rem;
        color: var(--text-color);
        margin-top: 0.5rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-color);
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-run-page">
    <div class="page-header">
        <h1>Test Runs & Results</h1>
        <div class="header-actions">
            <a href="{% url 'testcases:test_run_add' project_id=project.id %}" class="btn-add-run">
                <i class="fas fa-plus"></i> Add Test Run
            </a>
            <a href="{% url 'testcases:test_case_list' project_id=project.id %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Test Cases
            </a>
        </div>
    </div>
    
    <div class="filter-section">
        <label>Group By:</label>
        <select>
            <option>None</option>
        </select>
        <label>Order By:</label>
        <select>
            <option>Date</option>
        </select>
        <div style="margin-left: auto;">
            <span style="color: var(--text-color); opacity: 0.7;">
                {{ open_count }} open and {{ closed_count }} completed test runs in this project.
            </span>
        </div>
    </div>
    
    <div style="margin-bottom: 1rem;">
        <a href="?filter=open" style="margin-right: 1rem; color: var(--text-color); text-decoration: none; {% if filter_status == 'open' %}font-weight: bold;{% endif %}">Open</a>
        <a href="?filter=closed" style="margin-right: 1rem; color: var(--text-color); text-decoration: none; {% if filter_status == 'closed' %}font-weight: bold;{% endif %}">Closed</a>
        <a href="?filter=all" style="color: var(--text-color); text-decoration: none; {% if filter_status == 'all' %}font-weight: bold;{% endif %}">All</a>
    </div>
    
    <div class="test-runs-list">
        {% if test_runs_data %}
            {% for item in test_runs_data %}
                {% with test_run=item.test_run summary=item.summary %}
                <div class="test-run-card" onclick="window.location.href='{% url 'testcases:test_run_detail' project_id=project.id|stringformat:"s" test_run_id=test_run.id|stringformat:"s" %}'">
                    <div class="test-run-header">
                        <div>
                            <h3 class="test-run-title">{{ test_run.name }}</h3>
                            <div class="test-run-meta">
                                By {{ test_run.created_by.username|default:"Unknown" }} on {{ test_run.created_at|date:"n/j/Y" }}
                                <a href="{% url 'testcases:test_run_edit' project_id=project.id|stringformat:"s" test_run_id=test_run.id|stringformat:"s" %}" style="margin-left: 1rem; color: #007bff; text-decoration: none;" onclick="event.stopPropagation();">Edit</a>
                                <form method="post" action="{% url 'testcases:test_run_delete' project_id=project.id|stringformat:"s" test_run_id=test_run.id|stringformat:"s" %}" style="display: inline;" onclick="event.stopPropagation();" onsubmit="return confirm('Delete test run &quot;{{ test_run.name }}&quot;?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-link btn-sm text-danger" style="padding: 0 0.25rem; text-decoration: none;">
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="test-run-stats">
                        <span class="stat-item passed">{{ summary.passed }} Passed</span>
                        <span class="stat-item blocked">{{ summary.blocked }} Blocked</span>
                        <span class="stat-item retest">{{ summary.retest }} Retest</span>
                        <span class="stat-item failed">{{ summary.failed }} Failed</span>
                        <span class="stat-item">{{ summary.untested }} Untested</span>
                    </div>
                    
                    {% if summary.total > 0 %}
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            {% if summary.passed > 0 %}
                            <div class="progress-segment passed" style="width: {% widthratio summary.passed summary.total 100 %}%"></div>
                            {% endif %}
                            {% if summary.failed > 0 %}
                            <div class="progress-segment failed" style="width: {% widthratio summary.failed summary.total 100 %}%"></div>
                            {% endif %}
                            {% if summary.blocked > 0 %}
                            <div class="progress-segment blocked" style="width: {% widthratio summary.blocked summary.total 100 %}%"></div>
                            {% endif %}
                            {% if summary.retest > 0 %}
                            <div class="progress-segment retest" style="width: {% widthratio summary.retest summary.total 100 %}%"></div>
                            {% endif %}
                            {% if summary.untested > 0 %}
                            <div class="progress-segment untested" style="width: {% widthratio summary.untested summary.total 100 %}%"></div>
                            {% endif %}
                        </div>
                        <div class="progress-percent">{{ summary.passed_percent }}% passed</div>
                    </div>
                    {% else %}
                    <div class="progress-percent">0% passed ({{ summary.total }}/{{ summary.total }} untested (100%))</div>
                    {% endif %}
                    
                    {% if not test_run.end_date %}
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-color); opacity: 0.7;">No due date</div>
                    {% endif %}
                </div>
                {% endwith %}
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>No test runs found. <a href="{% url 'testcases:test_run_add' project_id=project.id %}" style="color: #007bff;">Create your first test run</a></p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

