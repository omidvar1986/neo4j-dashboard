{% extends 'dashboard/base.html' %}

{% block title %}Create Wallet{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Create a New Wallet</h2>
    <p>This page allows you to create a new wallet by providing the necessary details. The data will be sent to an external API to create the wallet.</p>
    
    <!-- Global Token Status -->
    <div id="tokenStatus" class="alert alert-info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <strong>Using global token:</strong> <span id="tokenPreview"></span>
        <a href="{% url 'dashboard:api_tools' %}" class="btn btn-sm btn-outline-primary ms-2">Change Token</a>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
    
    <!-- Selected User Display Section -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-user-check"></i> Selected User</h5>
        </div>
        <div class="card-body">
            <div id="selectedUserDisplay">
                <!-- User details will be populated here from centralized selection -->
            </div>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Create Wallet</button>
        <a href="{% url 'dashboard:api_tools' %}" class="btn btn-secondary">Back to API Tools</a>
    </form>
</div>

<script>
// Load selected user on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSelectedUser();
});

function loadSelectedUser() {
    // Try to get user from URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('selected_user_id');
    const userEmail = urlParams.get('selected_user_email');
    const userName = urlParams.get('selected_user_name');
    
    if (userId) {
        // User info from URL parameters
        const selectedUser = {
            user_id: userId,
            email: userEmail || '',
            full_name: userName || '',
            id: userId
        };
        displaySelectedUser(selectedUser);
        autoFillForm(selectedUser);
        return;
    }
    
    // Try to get user from session storage
    const storedUser = sessionStorage.getItem('selectedUser');
    if (storedUser) {
        try {
            const selectedUser = JSON.parse(storedUser);
            displaySelectedUser(selectedUser);
            autoFillForm(selectedUser);
            return;
        } catch (e) {
            console.error('Error parsing stored user:', e);
            sessionStorage.removeItem('selectedUser');
        }
    }
    
    // No user selected, redirect to API tools
    alert('No user selected. Please select a user first.');
    window.location.href = "{% url 'dashboard:api_tools' %}";
}

function displaySelectedUser(userInfo) {
    const selectedUserDisplay = document.getElementById('selectedUserDisplay');
    
    selectedUserDisplay.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> Selected User</h6>
            <div class="row">
                <div class="col-md-6">
                    <strong>Name:</strong> ${userInfo.full_name || 'N/A'}<br>
                    <strong>Email:</strong> ${userInfo.email || 'N/A'}
                </div>
                <div class="col-md-6">
                    <strong>User ID:</strong> ${userInfo.user_id || userInfo.uid || 'N/A'}<br>
                    <strong>Database ID:</strong> ${userInfo.id || 'N/A'}
                </div>
            </div>
        </div>
    `;
}

function autoFillForm(userInfo) {
    // Auto-fill the user_id field
    const userIdField = document.querySelector('input[name="user_id"]');
    if (userIdField) {
        userIdField.value = userInfo.user_id || userInfo.uid || userInfo.id;
    }
    
    // Show success message
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-info alert-dismissible fade show';
    successAlert.innerHTML = `
        <i class="fas fa-info-circle"></i> User ID has been automatically filled from your selection.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const form = document.querySelector('form');
    form.insertBefore(successAlert, form.firstChild);
}
</script>
{% endblock %}
