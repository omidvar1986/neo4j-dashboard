{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Add Transaction{% endblock %}

{% block extra_css %}
<style>
    .transaction-container {
        padding: 2rem 0;
        background: #f8f9fa;
        min-height: 100vh;
    }
    .transaction-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        background: white;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        display: block;
    }
    .form-control {
        border-radius: 5px;
        border: 1px solid #ddd;
        padding: 10px 12px;
        width: 100%;
        font-size: 14px;
    }
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }
    .btn-submit {
        background: #28a745;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .btn-submit:hover {
        background: #218838;
    }
    .btn-secondary {
        background: #6c757d;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-weight: 600;
        color: white;
        text-decoration: none;
        display: inline-block;
        margin-left: 10px;
    }
    .btn-secondary:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
    }
    .alert {
        border-radius: 5px;
        border: none;
        margin-bottom: 1rem;
    }
    .header-info {
        background: #1e3a8a;
        color: white;
        padding: 15px;
        border-radius: 5px 5px 0 0;
        margin-bottom: 0;
    }
    .card-body {
        padding: 20px;
    }
    .row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -10px;
    }
    .col-md-6 {
        flex: 0 0 50%;
        padding: 0 10px;
    }
    .text-center {
        text-align: center;
    }
    .mb-4 {
        margin-bottom: 1.5rem;
    }
    .mb-3 {
        margin-bottom: 1rem;
    }
    .mt-5 {
        margin-top: 3rem;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="transaction-container">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card transaction-card">
                    <div class="header-info">
                        <h2 style="margin: 0; color: white;">Add Transaction (افزودن تراکنش)</h2>
                    </div>
                    <div class="card-body">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <form method="post" id="transactionForm">
                            {% csrf_token %}
                            
                            <!-- User ID -->
                            <div class="form-group">
                                <label for="user_id" class="form-label">User ID *</label>
                                <input type="text" class="form-control" id="user_id" name="user_id" 
                                       value="{{ user_id|default:'Enter user ID' }}" 
                                       placeholder="Enter user ID" 
                                       {% if not user_id %}required{% endif %}>
                                <small style="color: #666; font-size: 12px;">
                                    {% if user_id %}
                                        Target user ID for the transaction
                                    {% else %}
                                        Enter the user ID for the transaction (extracted from session or manually entered)
                                    {% endif %}
                                </small>
                            </div>

                            <!-- Wallet Selection -->
                            <div class="form-group">
                                <label for="wallet" class="form-label">Wallet (کیف پول) *</label>
                                <select class="form-control" id="wallet" name="wallet" required>
                                    <option value="">---------</option>
                                </select>
                            </div>

                            <!-- Transaction Amount -->
                            <div class="form-group">
                                <label for="amount" class="form-label">Transaction Amount (مبلغ تراکنش) *</label>
                                <input type="number" class="form-control" id="amount" name="amount" 
                                       placeholder="مبلغ تراکنش" step="0.000001" required>
                            </div>

                            <!-- Description -->
                            <div class="form-group">
                                <label for="description" class="form-label">Description (توضیحات)</label>
                                <textarea class="form-control" id="description" name="description" rows="3" 
                                          placeholder="توضیحات">Add Transaction</textarea>
                            </div>

                            <!-- Target Transaction Entity (Optional) -->
                            <div class="form-group">
                                <label class="form-label">Target Transaction Entity (موجودیت هدف تراکنش) (اختیاری)</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="ref_id" class="form-label">Ref id</label>
                                        <input type="text" class="form-control" id="ref_id" name="ref_id" 
                                               placeholder="Ref id">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ref_module" class="form-label">Ref module</label>
                                        <select class="form-control" id="ref_module" name="ref_module">
                                            <option value="">---------</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="submit" class="btn-submit">
                                    Add Transaction (افزودن تراکنش)
                                </button>
                                <a href="{% url 'dashboard:transaction_management' %}" class="btn btn-success">
                                    <i class="fas fa-list"></i> View All Transactions
                                </a>
                                <a href="{% url 'dashboard:api_tools' %}" class="btn btn-secondary">
                                    Back to API Tools
                                </a>
                            </div>
                            
                            <!-- Global Token Status -->
                            <div id="tokenStatus" class="alert alert-info mt-3" style="display: none;">
                                <i class="fas fa-info-circle"></i>
                                <strong>Using global token:</strong> <span id="tokenPreview"></span>
                                <a href="{% url 'dashboard:api_tools' %}" class="btn btn-sm btn-outline-primary ms-2">Change Token</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load wallets when page loads
document.addEventListener('DOMContentLoaded', function() {
    const walletSelect = document.getElementById('wallet');
    
    // Check for global token first
    const globalToken = sessionStorage.getItem('globalAuthToken');
    if (globalToken) {
        // Show token status
        document.getElementById('tokenStatus').style.display = 'block';
        document.getElementById('tokenPreview').textContent = globalToken.substring(0, 20) + '...';
        
        // Try to automatically fetch user ID
        fetchUserIdAutomatically(globalToken);
    } else {
        // Redirect to API tools if no token
        window.location.href = "{% url 'dashboard:api_tools' %}";
    }
    
    // Add event listener for user ID input changes
    document.getElementById('user_id').addEventListener('input', function() {
        const userId = this.value.trim();
        if (userId && globalToken) {
            // Store the user ID in session storage
            sessionStorage.setItem('dynamicUserId', userId);
            // Store in localStorage for persistence across sessions
            localStorage.setItem('preferredUserId', userId);
            loadWallets(globalToken);
        } else {
            // Clear wallets if no user ID
            const walletSelect = document.getElementById('wallet');
            walletSelect.innerHTML = '<option value="">---------</option>';
        }
    });
});

function fetchUserIdAutomatically(token) {
    console.log('Attempting to automatically fetch user ID...');
    
    // First, check if we already have a user ID in session storage
    const existingUserId = sessionStorage.getItem('dynamicUserId');
    if (existingUserId) {
        console.log('Found existing user ID in session storage:', existingUserId);
        document.getElementById('user_id').value = existingUserId;
        loadWallets(token);
        return;
    }
    
    // Check localStorage for previously used user ID
    const preferredUserId = localStorage.getItem('preferredUserId');
    if (preferredUserId) {
        console.log('Found preferred user ID in localStorage:', preferredUserId);
        document.getElementById('user_id').value = preferredUserId;
        sessionStorage.setItem('dynamicUserId', preferredUserId);
        loadWallets(token);
        return;
    }
    
    // Try to get user ID from server
    fetch('{% url "dashboard:validate_token_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `auth_token=${encodeURIComponent(token)}`
    })
    .then(response => response.json())
    .then(data => {
        console.log('Server response for user ID:', data);
        if (data.success && data.user_info && data.user_info.user_id) {
            const userId = data.user_info.user_id;
            console.log('Successfully fetched user ID from server:', userId);
            
            // Store in session storage
            sessionStorage.setItem('dynamicUserId', userId);
            
            // Update the form
            document.getElementById('user_id').value = userId;
            
            // Hide the warning message
            const warningDiv = document.querySelector('.alert-warning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
            
            // Load wallets automatically
            loadWallets(token);
            
        } else {
            console.log('No user ID available from server, user will need to enter manually');
            // Show a more helpful message with common user IDs
            const warningDiv = document.querySelector('.alert-warning');
            if (warningDiv) {
                warningDiv.innerHTML = `
                    <i class="fas fa-info-circle"></i>
                    <strong>Session is valid but user ID not automatically detected.</strong><br>
                    Please enter your user ID below. You can find your user ID in your account settings or by checking the URL when logged into the admin panel.
                    <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'"></button>
                `;
            }
            
            // Don't pre-fill with hardcoded values - let user enter their own
            const userIdInput = document.getElementById('user_id');
            userIdInput.placeholder = 'Enter your user ID';
        }
    })
    .catch(error => {
        console.error('Error fetching user ID from server:', error);
        // Show error message
        const warningDiv = document.querySelector('.alert-warning');
        if (warningDiv) {
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                Error fetching user ID automatically. Please enter your user ID manually below.
                <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'"></button>
            `;
        }
    });
}

function loadWallets(token) {
    const walletSelect = document.getElementById('wallet');
    const userId = document.getElementById('user_id').value;
    
    console.log('Loading wallets for user ID:', userId, 'with token:', token.substring(0, 20) + '...');
    
    // Show loading state
    walletSelect.innerHTML = '<option value="">Loading wallets...</option>';
    
    // Make AJAX request to load wallets
    fetch('{% url "dashboard:load_wallets_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `user_id=${encodeURIComponent(userId)}&auth_token=${encodeURIComponent(token)}`
    })
    .then(response => response.json())
    .then(data => {
        console.log('Wallet loading response:', data);
        walletSelect.innerHTML = '<option value="">---------</option>';
        
        if (data.success && data.wallets && data.wallets.length > 0) {
            console.log('Loaded', data.wallets.length, 'wallets');
            data.wallets.forEach(wallet => {
                const option = document.createElement('option');
                option.value = wallet.value;
                option.textContent = wallet.text;
                walletSelect.appendChild(option);
            });
        } else {
            console.log('No wallets found or API error:', data);
            // Check if it's an access denied error
            if (data.error && data.error.includes('Access denied')) {
                walletSelect.innerHTML = '<option value="">Access denied - IP blocked by external API</option>';
            } else {
                walletSelect.innerHTML = '<option value="">No wallets found for this user</option>';
            }
        }
    })
    .catch(error => {
        console.error('Error loading wallets:', error);
        walletSelect.innerHTML = '<option value="">Error loading wallets</option>';
    });
}

// Form validation and token injection
document.getElementById('transactionForm').addEventListener('submit', function(e) {
    const amount = document.getElementById('amount').value;
    const wallet = document.getElementById('wallet').value;
    
    if (!wallet) {
        e.preventDefault();
        alert('Please select a wallet.');
        return;
    }
    
    if (!amount || amount <= 0) {
        e.preventDefault();
        alert('Please enter a valid amount greater than 0.');
        return;
    }
    
    // Add the global token to the form before submission
    const globalToken = sessionStorage.getItem('globalAuthToken');
    if (globalToken) {
        // Create a hidden input for the token
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = 'auth_token';
        tokenInput.value = globalToken;
        this.appendChild(tokenInput);
    }
});
</script>
{% endblock %}
